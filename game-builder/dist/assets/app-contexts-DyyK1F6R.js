import{r as m,j as z}from"./vendor-react-B5bTltmH.js";import{c as pe}from"./utils-CqSnstQE.js";const fe=m.createContext(void 0);function he({children:A}){const[I,o]=m.useState([]),t=(g,s)=>{const C=`notification-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;o(v=>[...v,{id:C,type:g,message:s}]),setTimeout(()=>{h(C)},5e3)},h=g=>{o(s=>s.filter(C=>C.id!==g))};return z.jsxs(fe.Provider,{value:{notifications:I,addNotification:t,removeNotification:h},children:[A,z.jsx("div",{className:"fixed bottom-4 right-4 space-y-2 z-50 max-w-sm",children:I.map(g=>z.jsxs("div",{className:`p-4 rounded-lg shadow-lg flex items-center space-x-3 ${g.type==="success"?"bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100":g.type==="error"?"bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100":g.type==="warning"?"bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100":"bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100"}`,children:[z.jsx("div",{className:"flex-1",children:g.message}),z.jsx("button",{onClick:()=>h(g.id),className:"text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100",children:z.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:z.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},g.id))})]})}let K=null,B={};const Q=[{id:"Soft_currency",name:"Луны",description:"Основная игровая валюта",color:"#FFD700",exchangeRate:1,isDefault:!0},{id:"Medium_currency",name:"Солы",description:"Переходящая валюта",color:"#00BFFF",exchangeRate:.1,isDefault:!1},{id:"Hard_currency",name:"Алетит",description:"Премиальная валюта",color:"#9932CC",exchangeRate:.01,isDefault:!1}],X={id:"default",name:"Default Configuration",baseValue:100,weights:{categoryWeight:.35,tierWeight:.25,mechanicWeight:.15,modifiersWeight:.1,locationsWeight:.05,frequencyWeight:.05,craftComplexityWeight:.05},categories:{Еда:1.2,Напитки:1,Урожай:.7,Материал:.6,Инструменты:1,Мусор:.1,Болты:.7,Дерево:.4,Грибы:.4,Балка:.5,Веревки:.4,Гвозди:.6,Детали:.9,"Корм для животных":1,Металл:.7,Приманка:.5,Насекомые:.2,Плоды:.9,Ингредиент:.5,Подарок:1.3,Провод:.6,Ресурсы:.3,Руды:.4,Минералы:.5,Рыба:1.3,Трава:.2,Семена:.2,Слиток:1.1,Сетка:.9,Стекло:.6,Ткань:1.2,Удобрения:.7,Цветы:.3,Топливо:.8},mechanics:{"Найти в мире":.7,"Можно купить":.8,Секретный:1.2,Специальный:1.5,"Квестовая награда":1,Крафтовое:1.1},tierMultiplier:.15,modifiers:{Ивентовое:1.5,Сезонное:1.3,"В ограниченное время":1.2,Проклято:.8,Сломано:.2,"Стартовый предмет":.1},subTypeModifiers:{Медный:1.1,Железный:1.2,Бронзовый:1.15,Стальной:1.25,Титановый:1.4,Золотой:1.5,Серебряный:1.3,Деревянный:.9,Дубовый:1,Сосновый:.85,Березовый:.8,Кукурузный:1.05,Пшеничный:.95,Льняной:1.1,Каменный:.9,Стеклянный:1.2,Кожаный:1.15,Тканевый:1.1,Мясной:1.3,Рыбный:1.2,Грибной:1.05,Ягодный:1.1,Овощной:.9,Фруктовый:1},locations:{Поместье:1.2,Лес:1.4,Город:.2,Горы:1.3},sellDiscount:.35,buyMarkup:.25,frequencyTypes:{"Часто встречаемый":1,"Редко встречаемый":1.8,"Единичный ресурс":3},craftComplexityTypes:{"Не крафтиться":1,"Очень легко":1.1,Легко:1.45,Средне:1.8,Сложно:2.1,"Очень сложно":2.6},craftBaseMultiplier:1.2,craftComplexityMultiplier:.1,currentSeason:"Весна",seasons:["Весна","Лето","Осень","Зима"],seasonalCategoryModifiers:{},seasonalSubTypeModifiers:{},growthDayMultiplier:5,craftTimeConfig:{baseTimesByComplexity:{"Очень легко":20,Легко:30,Средне:45,Сложно:60,"Очень сложно":90},ingredientBaseTime:3,ingredientScalingFactor:.7,levelMultiplier:.2,categoryTimeMultipliers:{},version:Date.now()},version:"1.0",createdAt:new Date().toISOString()},W={units:{units:[],items:[],abilities:[],nextImageId:1,imageMap:new Map,sorting:"name-asc",elementFilter:"all",itemSorting:"name-asc",abilitySorting:"name-asc",rarities:[{id:"common",name:"Common",value:0},{id:"uncommon",name:"Uncommon",value:1},{id:"rare",name:"Rare",value:2},{id:"exotic",name:"Exotic",value:3},{id:"epic",name:"Epic",value:4},{id:"mythical",name:"Mythical",value:5},{id:"legendary",name:"Legendary",value:6},{id:"relic",name:"Relic",value:7},{id:"immortal",name:"Immortal",value:8},{id:"ancient",name:"Ancient",value:9}],currentUnitAbilities:[],currentUnitGearRequirements:new Map},resources:{items:[],categories:[{id:"materials",name:"Materials",color:"#5D5CDE",description:"Basic crafting materials"}],imageMap:new Map,nextImageId:1},recipes:{recipes:[],nextId:1},balance:{currentConfig:X,savedConfigs:[X],comparisonItems:[]},craftSystem:{recipes:[],variants:[],nextRecipeId:1,nextVariantId:1},mixingSystem:{recipes:[],spoiledFood:[{type:"meat",name:"Испорченное мясное блюдо",imageId:"",description:"Испортившееся мясное блюдо"},{type:"fish",name:"Испорченное рыбное блюдо",imageId:"",description:"Испортившееся рыбное блюдо"},{type:"general",name:"Испорченное блюдо",imageId:"",description:"Испортившаяся еда"}],nextRecipeId:1},shopSystem:{currencies:Q,traders:[],shops:[],nextTraderIdCounter:1,nextShopIdCounter:1}},te=m.createContext(void 0);function Se({children:A}){const[I,o]=m.useState(W),t=(s,C)=>{if(console.log(`Updating state path: ${s}`,C),s==="balance"&&C&&C.currentConfig&&C.currentConfig.id&&C.currentConfig.id!=="default"){console.log(`Обновление всего объекта balance с currentConfig.id=${C.currentConfig.id}`),K=JSON.parse(JSON.stringify(C.currentConfig)),o(v=>({...v,balance:C}));return}if(s==="balance.currentConfig"&&C&&C.id&&C.id!=="default"){console.log(`Обновление balance.currentConfig с id=${C.id}`);const v=JSON.parse(JSON.stringify(C));K=v,o(i=>{const w={...i,balance:{...i.balance,currentConfig:v}};return setTimeout(()=>{console.log("После обновления, currentConfig.id =",w.balance.currentConfig.id)},0),w});return}o(v=>{if(!s.includes("."))return console.log(`Updating root property: ${s}`),{...v,[s]:C};const i=s.split("."),w={...v};let R=w;for(let b=0;b<i.length-1;b++){const M=i[b];R[M]||(R[M]={}),R[M]={...R[M]},R=R[M]}return R[i[i.length-1]]=C,i[0]==="balance"&&i[1]==="currentConfig"&&w.balance.currentConfig.id==="default"&&K&&K.id!=="default"&&(console.log("ВНИМАНИЕ: ID конфигурации был сброшен к 'default', восстанавливаем из резервной копии"),w.balance.currentConfig.id=K.id),w})};function h(s){var w,R;console.log("Начинаем миграцию импортированных данных...");const C=((w=s.units)==null?void 0:w.imageMap)instanceof Map?s.units.imageMap:B.units||new Map,v=((R=s.resources)==null?void 0:R.imageMap)instanceof Map?s.resources.imageMap:B.resources||new Map;console.log(`Сохранили оригинальные Map изображений перед миграцией: units=${C.size}, resources=${v.size}`);const i=JSON.parse(JSON.stringify(W));try{if(s.units&&(i.units.units=s.units.units||[],i.units.items=s.units.items||[],i.units.abilities=s.units.abilities||[],i.units.nextImageId=s.units.nextImageId||1,i.units.sorting=s.units.sorting||"name-asc",i.units.elementFilter=s.units.elementFilter||"all",i.units.itemSorting=s.units.itemSorting||"name-asc",i.units.abilitySorting=s.units.abilitySorting||"name-asc",i.units.rarities=s.units.rarities||i.units.rarities,i.units.currentUnitAbilities=s.units.currentUnitAbilities||[]),s.resources&&(i.resources.items=s.resources.items||[],i.resources.categories=s.resources.categories||i.resources.categories,i.resources.nextImageId=s.resources.nextImageId||1),s.recipes&&(i.recipes.recipes=s.recipes.recipes||[],i.recipes.nextId=s.recipes.nextId||1),s.balance&&(s.balance.currentConfig&&(i.balance.currentConfig={...X,...s.balance.currentConfig}),s.balance.savedConfigs&&Array.isArray(s.balance.savedConfigs)&&(i.balance.savedConfigs=s.balance.savedConfigs.map(b=>({...X,...b}))),s.balance.comparisonItems&&Array.isArray(s.balance.comparisonItems)&&(i.balance.comparisonItems=s.balance.comparisonItems)),s.craftSystem){console.log("Миграция данных Crafting System:",s.craftSystem),i.craftSystem={...i.craftSystem,...s.craftSystem,recipes:[],variants:[]},i.craftSystem.nextRecipeId=s.craftSystem.nextRecipeId||1,i.craftSystem.nextVariantId=s.craftSystem.nextVariantId||1,s.craftSystem.recipes&&Array.isArray(s.craftSystem.recipes)&&(console.log(`Импортирую ${s.craftSystem.recipes.length} рецептов`),i.craftSystem.recipes=s.craftSystem.recipes.map(S=>{var O,F,j,_;try{if(S.resultItemName!==void 0){const k=JSON.parse(JSON.stringify(S));return console.log(`Импортирован рецепт: ${k.name} (${k.id})`),k}const N={id:S.id||`recipe-${i.craftSystem.nextRecipeId++}`,name:S.name||"Unknown Recipe",resultItemName:"",resultAmount:S.resultAmount||1,category:S.category||"",level:S.level||1,imageId:S.imageId||null,variants:[]};if(S.resultItemId){const k=(F=(O=s.resources)==null?void 0:O.items)==null?void 0:F.find(E=>E.id===S.resultItemId);if(k)N.resultItemName=k.name,console.log(`Преобразовано: resultItemId=${S.resultItemId} -> resultItemName=${N.resultItemName}`);else{const E=(_=(j=s.balance)==null?void 0:j.comparisonItems)==null?void 0:_.find(V=>V.id===S.resultItemId);E?(N.resultItemName=E.name,console.log(`Преобразовано из баланса: resultItemId=${S.resultItemId} -> resultItemName=${N.resultItemName}`)):(N.resultItemName=S.resultItemId,console.log(`Не найден предмет с ID=${S.resultItemId}, используем как имя`))}}return S.variants&&Array.isArray(S.variants)?N.variants=S.variants.map(k=>{const E={id:k.id||`variant-${i.craftSystem.nextVariantId++}`,name:k.name||"Standard",ingredients:[],fuelItems:k.fuelItems?k.fuelItems.map(V=>({itemName:V.itemName,amount:V.amount||1})):[]};return k.ingredients&&Array.isArray(k.ingredients)&&(E.ingredients=k.ingredients.map(V=>{var q,P,p,e;const $={itemName:"",amount:V.amount||1};if(V.itemId){const a=(P=(q=s.resources)==null?void 0:q.items)==null?void 0:P.find(n=>n.id===V.itemId);if(a)$.itemName=a.name;else{const n=(e=(p=s.balance)==null?void 0:p.comparisonItems)==null?void 0:e.find(f=>f.id===V.itemId);n?$.itemName=n.name:$.itemName=V.itemId}}else V.itemName&&($.itemName=V.itemName);return $})),E}):N.variants=[{id:`variant-${i.craftSystem.nextVariantId++}`,name:"Standard",ingredients:[],fuelItems:[]}],S.requiresFuel!==void 0&&(N.requiresFuel=S.requiresFuel),console.log(`Преобразован рецепт: ${N.name} (${N.id})`),N}catch(N){return console.error("Ошибка при миграции рецепта:",N),{id:`recipe-${i.craftSystem.nextRecipeId++}`,name:"Error Recipe",resultItemName:"Unknown",resultAmount:1,category:"",level:1,imageId:null,variants:[{id:`variant-${i.craftSystem.nextVariantId++}`,name:"Standard",ingredients:[],fuelItems:[]}]}}}),console.log(`Миграция рецептов завершена, импортировано ${i.craftSystem.recipes.length} рецептов`));const b=Math.max(0,...i.craftSystem.recipes.map(S=>{const O=parseInt(S.id.replace("recipe-",""),10);return isNaN(O)?0:O})),M=Math.max(0,...i.craftSystem.recipes.flatMap(S=>S.variants.map(O=>{const F=parseInt(O.id.replace("variant-",""),10);return isNaN(F)?0:F})));b>=i.craftSystem.nextRecipeId&&(i.craftSystem.nextRecipeId=b+1,console.log(`Скорректирован nextRecipeId: ${i.craftSystem.nextRecipeId}`)),M>=i.craftSystem.nextVariantId&&(i.craftSystem.nextVariantId=M+1,console.log(`Скорректирован nextVariantId: ${i.craftSystem.nextVariantId}`))}if(s.mixingSystem){console.log("Миграция данных Mixing System:",s.mixingSystem),i.mixingSystem={recipes:s.mixingSystem.recipes||[],spoiledFood:s.mixingSystem.spoiledFood||i.mixingSystem.spoiledFood,nextRecipeId:s.mixingSystem.nextRecipeId||1};const b=Math.max(0,...i.mixingSystem.recipes.map(M=>{const S=parseInt(M.id.replace("mixing-",""),10);return isNaN(S)?0:S}));b>=i.mixingSystem.nextRecipeId&&(i.mixingSystem.nextRecipeId=b+1,console.log(`Скорректирован mixingSystem.nextRecipeId: ${i.mixingSystem.nextRecipeId}`))}else console.log("Данные Mixing System отсутствуют, используются значения по умолчанию");return s.shopSystem?(console.log("Миграция данных Shop System:",s.shopSystem),i.shopSystem={currencies:s.shopSystem.currencies||Q,traders:s.shopSystem.traders||[],shops:s.shopSystem.shops||[],nextTraderIdCounter:s.shopSystem.nextTraderIdCounter||1,nextShopIdCounter:s.shopSystem.nextShopIdCounter||1}):console.log("Данные Shop System отсутствуют, используются значения по умолчанию"),i.units.imageMap=C,i.resources.imageMap=v,console.log(`Восстановлены Map изображений: units=${i.units.imageMap.size}, resources=${i.resources.imageMap.size}`),console.log("Миграция данных успешно завершена"),i}catch(b){console.error("Ошибка при миграции данных:",b);const M=JSON.parse(JSON.stringify(W));return M.units.imageMap=C,M.resources.imageMap=v,M}}const g=async s=>{var C,v,i,w,R,b,M,S,O,F,j,_,N,k,E,V,$,q,P;console.log("Setting full application state"),console.log("Входные данные для импорта:",{hasCraftSystem:!!s.craftSystem,craftRecipesCount:((v=(C=s.craftSystem)==null?void 0:C.recipes)==null?void 0:v.length)||0,hasMixingSystem:!!s.mixingSystem,mixingRecipesCount:((w=(i=s.mixingSystem)==null?void 0:i.recipes)==null?void 0:w.length)||0,hasShopSystem:!!s.shopSystem,shopsCount:((b=(R=s.shopSystem)==null?void 0:R.shops)==null?void 0:b.length)||0});try{s.units.imageMap instanceof Map&&s.units.imageMap.size>0&&(B.units=s.units.imageMap,console.log(`Сохранили ${s.units.imageMap.size} изображений units в глобальной переменной`)),s.resources.imageMap instanceof Map&&s.resources.imageMap.size>0&&(B.resources=s.resources.imageMap,console.log(`Сохранили ${s.resources.imageMap.size} изображений resources в глобальной переменной`)),(!s.craftSystem||!Array.isArray(s.craftSystem.recipes))&&(console.warn("ВНИМАНИЕ: В импортируемых данных отсутствует craftSystem или рецепты"),s.craftSystem={recipes:[],variants:[],nextRecipeId:1,nextVariantId:1}),s.mixingSystem||(console.warn("ВНИМАНИЕ: В импортируемых данных отсутствует mixingSystem"),s.mixingSystem={recipes:[],spoiledFood:W.mixingSystem.spoiledFood,nextRecipeId:1}),s.shopSystem||(console.warn("ВНИМАНИЕ: В импортируемых данных отсутствует shopSystem"),s.shopSystem={currencies:Q,traders:[],shops:[],nextTraderIdCounter:1,nextShopIdCounter:1});const p=h(s);console.log("Данные после миграции:",{hasCraftSystem:!!p.craftSystem,craftRecipesCount:((S=(M=p.craftSystem)==null?void 0:M.recipes)==null?void 0:S.length)||0,hasMixingSystem:!!p.mixingSystem,mixingRecipesCount:((F=(O=p.mixingSystem)==null?void 0:O.recipes)==null?void 0:F.length)||0,hasShopSystem:!!p.shopSystem,shopsCount:((_=(j=p.shopSystem)==null?void 0:j.shops)==null?void 0:_.length)||0}),(!p.craftSystem||!Array.isArray(p.craftSystem.recipes))&&(console.error("ОШИБКА: После миграции craftSystem или рецепты отсутствуют"),p.craftSystem={recipes:((N=p.craftSystem)==null?void 0:N.recipes)||[],variants:((k=p.craftSystem)==null?void 0:k.variants)||[],nextRecipeId:((E=p.craftSystem)==null?void 0:E.nextRecipeId)||1,nextVariantId:((V=p.craftSystem)==null?void 0:V.nextVariantId)||1}),p.mixingSystem||(console.error("ОШИБКА: После миграции mixingSystem отсутствует"),p.mixingSystem={recipes:[],spoiledFood:W.mixingSystem.spoiledFood,nextRecipeId:1}),p.shopSystem||(console.error("ОШИБКА: После миграции shopSystem отсутствует"),p.shopSystem={currencies:Q,traders:[],shops:[],nextTraderIdCounter:1,nextShopIdCounter:1});const e={...p,units:{...p.units,imageMap:p.units.imageMap instanceof Map?p.units.imageMap:new Map(Object.entries(p.units.imageMap||{})),currentUnitGearRequirements:p.units.currentUnitGearRequirements instanceof Map?p.units.currentUnitGearRequirements:new Map},resources:{...p.resources,imageMap:p.resources.imageMap instanceof Map?p.resources.imageMap:new Map(Object.entries(p.resources.imageMap||{}))},balance:p.balance||W.balance,craftSystem:p.craftSystem||W.craftSystem,mixingSystem:p.mixingSystem||W.mixingSystem,shopSystem:p.shopSystem||W.shopSystem};if(console.log("DEBUG - ImageMap после преобразования:",{unitsImageMapSize:e.units.imageMap.size,resourcesImageMapSize:e.resources.imageMap.size}),console.log("DEBUG - Ключи в units.imageMap:",Array.from(e.units.imageMap.keys())),console.log("DEBUG - Ключи в resources.imageMap:",Array.from(e.resources.imageMap.keys())),e.balance&&e.balance.comparisonItems){const a=e.balance.comparisonItems.filter(n=>n.imageId);console.log(`DEBUG - В comparisonItems найдено ${a.length} элементов с imageId`),a.forEach(n=>{const{name:f,imageId:d}=n,r=d&&e.units.imageMap.has(d),l=d&&e.resources.imageMap.has(d);console.log(`DEBUG - Элемент "${f}" имеет imageId="${d}" который ${r||l?"существует":"НЕ существует"} в imageMap`)})}return e.craftSystem&&(Array.isArray(e.craftSystem.recipes)?e.craftSystem.recipes=JSON.parse(JSON.stringify(e.craftSystem.recipes)):e.craftSystem.recipes=[],Array.isArray(e.craftSystem.variants)?e.craftSystem.variants=JSON.parse(JSON.stringify(e.craftSystem.variants)):e.craftSystem.variants=[],e.craftSystem.nextRecipeId||(e.craftSystem.nextRecipeId=1),e.craftSystem.nextVariantId||(e.craftSystem.nextVariantId=1)),e.mixingSystem&&(Array.isArray(e.mixingSystem.recipes)?e.mixingSystem.recipes=JSON.parse(JSON.stringify(e.mixingSystem.recipes)):e.mixingSystem.recipes=[],Array.isArray(e.mixingSystem.spoiledFood)||(e.mixingSystem.spoiledFood=W.mixingSystem.spoiledFood),e.mixingSystem.nextRecipeId||(e.mixingSystem.nextRecipeId=1)),e.shopSystem&&(Array.isArray(e.shopSystem.currencies)?e.shopSystem.currencies=JSON.parse(JSON.stringify(e.shopSystem.currencies)):e.shopSystem.currencies=Q,Array.isArray(e.shopSystem.traders)?e.shopSystem.traders=JSON.parse(JSON.stringify(e.shopSystem.traders)):e.shopSystem.traders=[],Array.isArray(e.shopSystem.shops)?e.shopSystem.shops=JSON.parse(JSON.stringify(e.shopSystem.shops)):e.shopSystem.shops=[],e.shopSystem.nextTraderIdCounter||(e.shopSystem.nextTraderIdCounter=1),e.shopSystem.nextShopIdCounter||(e.shopSystem.nextShopIdCounter=1)),console.log("Финальная проверка перед обновлением:",{craftSystem:{recipesCount:e.craftSystem.recipes.length,nextRecipeId:e.craftSystem.nextRecipeId,nextVariantId:e.craftSystem.nextVariantId},mixingSystem:{recipesCount:e.mixingSystem.recipes.length,spoiledFoodCount:e.mixingSystem.spoiledFood.length,nextRecipeId:e.mixingSystem.nextRecipeId},shopSystem:{currenciesCount:(($=e.shopSystem)==null?void 0:$.currencies.length)||0,tradersCount:((q=e.shopSystem)==null?void 0:q.traders.length)||0,shopsCount:((P=e.shopSystem)==null?void 0:P.shops.length)||0}}),e.units.imageMap.size===0&&B.units&&B.units.size>0&&(console.log(`ЭКСТРЕННОЕ ВОССТАНОВЛЕНИЕ: восстанавливаем ${B.units.size} изображений из глобальной переменной`),e.units.imageMap=B.units),e.resources.imageMap.size===0&&B.resources&&B.resources.size>0&&(console.log(`ЭКСТРЕННОЕ ВОССТАНОВЛЕНИЕ: восстанавливаем ${B.resources.size} изображений из глобальной переменной`),e.resources.imageMap=B.resources),o(e),console.log("Full state update completed"),setTimeout(()=>{B={},console.log("Очищено временное хранилище изображений")},5e3),Promise.resolve()}catch(p){return console.error("Ошибка при импорте данных:",p),o(W),alert("Произошла ошибка при импорте данных. Используются настройки по умолчанию."),Promise.reject(p)}};return z.jsx(te.Provider,{value:{state:I,updateState:t,setFullState:g},children:A})}function re(){const A=m.useContext(te);if(A===void 0)throw new Error("useAppState must be used within an AppStateProvider");return A}const ne=m.createContext(null);function Ce(){const A=m.useContext(ne);if(A===null)throw new Error("useBalance must be used within a BalanceProvider");return A}const Z=["Весна","Лето","Осень","Зима"];function Ie({children:A}){const{state:I,updateState:o}=re(),t=I.balance.currentConfig,h=I.balance.savedConfigs,g=I.balance.comparisonItems,s=m.useRef(new Map),C=m.useRef({timer:null,lastUpdateTime:0,isUpdating:!1,pendingUpdate:!1,hasInitialUpdate:!1}),v=(e,a)=>{if(e===a)return!0;if(e===null||a===null)return!1;if(typeof e!="object"||typeof a!="object")return e===a;const n=Object.keys(e),f=Object.keys(a);if(n.length!==f.length)return!1;for(const d of n)if(d!=="version"&&!v(e[d],a[d]))return!1;return!0},i=m.useRef({config:null,timestamp:0}),w=m.useCallback(e=>{const a=Date.now();if(a-i.current.timestamp<200&&i.current.config&&!(e.craftTimeConfig&&Object.keys(e).length===1&&Object.keys(e.craftTimeConfig).length===1&&"version"in e.craftTimeConfig)){console.log("🚫 Обновление пропущено - слишком частое");return}if(e.craftTimeConfig&&t.craftTimeConfig&&!(Object.keys(e.craftTimeConfig).length===1&&"version"in e.craftTimeConfig)){const r={...e.craftTimeConfig};delete r.version;const l={...t.craftTimeConfig};if(delete l.version,v(r,l)&&Object.keys(e).length===1){console.log("🚫 Обновление пропущено - нет реальных изменений в craftTimeConfig");return}}i.current={config:e,timestamp:a};const f={...t,...e};(e.baseValue!==void 0||e.tierMultiplier!==void 0||e.weights!==void 0||e.categories!==void 0||e.mechanics!==void 0||e.craftBaseMultiplier!==void 0||e.craftComplexityMultiplier!==void 0||e.subTypeModifiers!==void 0||e.currentSeason!==void 0||e.seasonalCategoryModifiers!==void 0||e.seasonalSubTypeModifiers!==void 0||e.growthDayMultiplier!==void 0)&&(console.log("🧹 Очистка кэша расчета цен из-за изменения параметров"),s.current.clear()),console.log("✅ Конфигурация баланса обновлена:",e),o("balance.currentConfig",f)},[t,o]),R=m.useCallback(()=>{const e=C.current;e.isUpdating=!0,console.log("🔄 Выполняется обновление craftValue..."),setTimeout(()=>{try{if(!I.craftSystem.recipes||I.craftSystem.recipes.length===0){console.log("Нет рецептов для обновления craftValue"),e.isUpdating=!1;return}const a=[...g];let n=!1,f=0;const d=I.resources.items.map(c=>({name:c.name,tier:1,mechanic:"Найти в мире",selectedCategories:[c.category],selectedModifiers:[],selectedLocations:[],frequencyType:"Часто встречаемый",craftComplexity:"Не крафтиться",imageId:c.imageId||null})),r=[...a,...d],l=new Set(I.craftSystem.recipes.map(c=>c.resultItemName));a.forEach((c,u)=>{const y=l.has(c.name);if(y&&(!c.hasCraftRecipe||c.craftValue===void 0)||!y&&c.hasCraftRecipe)if(y){const x=I.craftSystem.recipes.find(T=>T.resultItemName===c.name);if(x)try{const T=pe(x,r,t);a[u]={...a[u],hasCraftRecipe:!0,craftValue:T},n=!0,f++}catch(T){console.error(`Ошибка при расчете craftValue для ${x.resultItemName}:`,T)}}else a[u]={...a[u],hasCraftRecipe:!1,craftValue:void 0},n=!0,f++}),n?(console.log(`✅ Сохраняем обновленные значения craftValue (${f} изменений)`),o("balance.comparisonItems",a)):console.log("🚫 Нет изменений в craftValue - обновление не требуется"),e.lastUpdateTime=Date.now(),setTimeout(()=>{e.isUpdating=!1,e.pendingUpdate&&(e.pendingUpdate=!1,b())},300)}catch(a){console.error("Ошибка при обновлении craftValue:",a),e.isUpdating=!1}},0)},[I.craftSystem.recipes,g,t,I.resources.items,o]),b=m.useCallback(()=>{const e=C.current,a=Date.now(),n=2500,f=a.toString();if(e.lastCallId&&a-(e.lastCallIdTime||0)<100)return;if(e.lastCallId=f,e.lastCallIdTime=a,!e.hasInitialUpdate){e.hasInitialUpdate=!0,e.lastUpdateTime=a,console.log("🔄 Первое обновление craftValue..."),R();return}if(console.log("🔄 Запланировано обновление craftValue..."),e.isUpdating){e.pendingUpdate=!0,console.log("⏳ Обновление craftValue уже выполняется, следующее будет отложено");return}const d=a-e.lastUpdateTime;if(d<n){e.timer&&clearTimeout(e.timer),console.log(`⏳ Отложено обновление craftValue на ${n-d}мс`),e.timer=setTimeout(()=>{e.lastCallId===f&&R()},n-d);return}R()},[R]);m.useEffect(()=>{const e=setTimeout(()=>{(t.craftBaseMultiplier!==void 0||t.craftComplexityMultiplier!==void 0||t.baseValue!==void 0||t.weights!==void 0)&&b()},800);return()=>clearTimeout(e)},[t,b]);const M=m.useCallback(e=>{if(!t.seasons||!t.seasons.includes(e)){console.error(`Сезон "${e}" не найден в списке сезонов`);return}w({currentSeason:e}),s.current.clear()},[t.seasons,w]),S=m.useCallback(e=>{const a={...t,name:e||t.name,createdAt:new Date().toISOString(),craftTimeConfig:t.craftTimeConfig?{...t.craftTimeConfig,version:Date.now()}:t.craftTimeConfig},n=h.findIndex(f=>f.id===a.id);if(n!==-1){const f=[...h];f[n]=a,o("balance.savedConfigs",f)}else o("balance.savedConfigs",[...h,a]);o("balance.currentConfig",a)},[t,h,o]),O=m.useCallback(e=>{console.log("Создаем новую конфигурацию:",e);const a=`config-${Date.now()}`,n=t.seasons||Z,f=t.currentSeason||n[0];let d=t.seasonalCategoryModifiers||{};(!d||Object.keys(d).length===0)&&(d={},Object.keys(t.categories).forEach(u=>{d[u]={},n.forEach(y=>{d[u][y]=1})}));let r=t.seasonalSubTypeModifiers||{};(!r||Object.keys(r).length===0)&&(r={},t.subTypeModifiers&&Object.keys(t.subTypeModifiers).forEach(u=>{r[u]={},n.forEach(y=>{r[u][y]=1})}));const l={id:a,name:e,baseValue:t.baseValue,weights:{...t.weights},categories:{...t.categories},mechanics:{...t.mechanics},tierMultiplier:t.tierMultiplier,modifiers:{...t.modifiers},locations:{...t.locations},frequencyTypes:{...t.frequencyTypes},craftComplexityTypes:{...t.craftComplexityTypes},subTypeModifiers:t.subTypeModifiers?{...t.subTypeModifiers}:{},currentSeason:f,seasons:[...n],seasonalCategoryModifiers:JSON.parse(JSON.stringify(d)),seasonalSubTypeModifiers:JSON.parse(JSON.stringify(r)),growthDayMultiplier:t.growthDayMultiplier||5,sellDiscount:t.sellDiscount,buyMarkup:t.buyMarkup,craftBaseMultiplier:t.craftBaseMultiplier,craftComplexityMultiplier:t.craftComplexityMultiplier,craftTimeConfig:t.craftTimeConfig?{...t.craftTimeConfig,categoryTimeMultipliers:{...t.craftTimeConfig.categoryTimeMultipliers},version:Date.now()}:{baseTimesByComplexity:{"Очень легко":20,Легко:30,Средне:45,Сложно:60,"Очень сложно":90},ingredientBaseTime:3,ingredientScalingFactor:.7,levelMultiplier:.2,categoryTimeMultipliers:{...t.categories},version:Date.now()},version:t.version,createdAt:new Date().toISOString()};if(console.log("Новая конфигурация с ID:",l.id),t.id!=="default"){const u=h.find(y=>y.id===t.id);if(!u||!v(u,t)){console.log("Сохраняем текущую конфигурацию перед переключением");const y=h.filter(x=>x.id!==t.id);y.push({...t}),o("balance.savedConfigs",y)}}(async()=>{console.log("Добавляем новую конфигурацию в список"),o("balance.savedConfigs",[...h,l]),await new Promise(u=>setTimeout(u,100)),console.log("Устанавливаем новую конфигурацию как текущую"),o("balance.currentConfig",l),s.current.clear()})()},[t,h,o]),F=m.useCallback(e=>{const a=h.find(n=>n.id===e);if(a){console.log("📂 Загружаем конфигурацию:",a.name);let n={...a};(!n.seasons||n.seasons.length===0)&&(n.seasons=Z),(!n.currentSeason||!n.seasons.includes(n.currentSeason))&&(n.currentSeason=n.seasons[0]),n.seasonalCategoryModifiers||(n.seasonalCategoryModifiers={},Object.keys(n.categories).forEach(d=>{n.seasonalCategoryModifiers[d]={},n.seasons.forEach(r=>{n.seasonalCategoryModifiers[d][r]=1})})),n.seasonalSubTypeModifiers||(n.seasonalSubTypeModifiers={},n.subTypeModifiers&&Object.keys(n.subTypeModifiers).forEach(d=>{n.seasonalSubTypeModifiers[d]={},n.seasons.forEach(r=>{n.seasonalSubTypeModifiers[d][r]=1})})),n.growthDayMultiplier===void 0&&(n.growthDayMultiplier=5);const f={...n,craftTimeConfig:n.craftTimeConfig?{...n.craftTimeConfig,version:Date.now()}:n.craftTimeConfig};o("balance.currentConfig",f),s.current.clear()}},[h,o]),j=m.useCallback(e=>{const a=h.filter(n=>n.id!==e);o("balance.savedConfigs",a)},[h,o]),_=m.useCallback(e=>{e.imageId===void 0&&(e.imageId=null),o("balance.comparisonItems",[...g,e])},[g,o]),N=m.useCallback(e=>{const a=[...g];a.splice(e,1),o("balance.comparisonItems",a)},[g,o]),k=m.useCallback((e,a)=>{if(e<0||e>=g.length){console.error(`Invalid index: ${e}, items length: ${g.length}`);return}const n=[...g];a.imageId===void 0&&(a.imageId=null),n[e]=a,o("balance.comparisonItems",n)},[g,o]),E=m.useCallback(e=>{if(!e)return 0;if(e.craftValue!==void 0&&e.craftValue>0&&e.hasCraftRecipe===!0)return e.craftValue;if(e.isHarvest){const G=e.seedCost||0,H=e.growingTime||0,ue=e.harvestPerSeason||1,me=t.growthDayMultiplier||1,de=(G+H*me)/ue;return Math.round(de)}const a=t.weights.categoryWeight||0,n=t.weights.tierWeight||0,f=t.weights.mechanicWeight||0,d=t.weights.modifiersWeight||0,r=t.weights.locationsWeight||0,l=t.weights.frequencyWeight||0,c=t.weights.craftComplexityWeight||0,u=t.baseValue||0,y=t.tierMultiplier||0,x=e.selectedCategories.reduce((G,H)=>G+(t.categories[H]||0),0),T=a*(e.selectedCategories.length>0?x/e.selectedCategories.length:0),J=n*(1+(e.tier-1)*y),U=f*(t.mechanics[e.mechanic]||1),L=e.selectedModifiers.reduce((G,H)=>G+(t.modifiers[H]||0),0),Y=d*(e.selectedModifiers.length>0?L/e.selectedModifiers.length:1),ae=e.selectedLocations.reduce((G,H)=>G+(t.locations[H]||0),0),oe=r*(e.selectedLocations.length>0?ae/e.selectedLocations.length:1),ce=l*(t.frequencyTypes[e.frequencyType]||1),le=c*(t.craftComplexityTypes[e.craftComplexity]||1);let D=1;e.subType&&t.subTypeModifiers&&t.subTypeModifiers[e.subType]&&(D=t.subTypeModifiers[e.subType]);let ee=u*(T+J+U+Y+oe+ce+le);return ee*=D,Math.round(ee)},[t]),V=m.useCallback((e,a)=>{if(!a||!t.seasons||!t.seasons.includes(a))return 1;let n=1;if(t.seasonalCategoryModifiers&&(e.selectedCategories.forEach(f=>{const d=t.seasonalCategoryModifiers[f];d&&d[a]&&(n*=d[a]||1)}),e.selectedCategories.length>0&&(n=Math.pow(n,1/e.selectedCategories.length))),e.subType&&t.seasonalSubTypeModifiers){const f=t.seasonalSubTypeModifiers[e.subType];f&&f[a]&&(n*=f[a]||1)}return e.isHarvest&&e.growingSeason&&(e.growingSeason.includes(a)||(n*=1.5)),n},[t]),$=m.useCallback((e,a)=>{if(!e)return 0;const n=a||t.currentSeason,f=`${e.name}_${e.tier}_${e.subType||"none"}_${n}_${t.id}_${t.version}_${e.hasCraftRecipe}_${e.craftValue}_${e.selectedCategories.join(",")}_${e.selectedModifiers.join(",")}_${e.selectedLocations.join(",")}_${e.frequencyType||""}_${e.craftComplexity||""}`;if(s.current.has(f)){const c=s.current.get(f);return c!==void 0?c:0}const d=E(e),r=V(e,n),l=Math.round(d*r);return s.current.set(f,l),l},[t,E,V]),q=m.useCallback(e=>$(e,t.currentSeason),[$,t.currentSeason]),P=m.useCallback(e=>{if(!e.isHarvest)return{};const a={};return(t.seasons||Z).forEach(f=>{const d=$(e,f),r=e.seedCost||0,l=e.growingTime||1,c=(d-r)/l;a[f]=c}),a},[t.seasons,$]),p=m.useMemo(()=>({currentConfig:t,savedConfigs:h,comparisonItems:g,updateConfig:w,saveCurrentConfig:S,createNewConfig:O,loadConfig:F,deleteConfig:j,addItemToComparison:_,removeItemFromComparison:N,calculateItemCost:q,calculateSeasonalItemCost:$,updateItemInComparison:k,updateCraftValuesForAllItems:b,setCurrentSeason:M,getSeasonalProfitability:P}),[t,h,g,w,S,O,F,j,_,N,q,$,k,b,M,P]);return z.jsx(ne.Provider,{value:p,children:A})}const ie=m.createContext(null),se=[{id:"Soft_currency",name:"Луны",description:"Основная игровая валюта",exchangeRate:1,isDefault:!0},{id:"Medium_currency",name:"Солы",description:"Переходящая валюта",exchangeRate:100,isDefault:!1},{id:"Hard_currency",name:"Алетит",description:"Премиум валюта",exchangeRate:20,isDefault:!1}];function xe({children:A}){var f,d;const{state:I,updateState:o}=re();m.useEffect(()=>{I.shopSystem||o("shopSystem",{currencies:se,traders:[],shops:[],nextTraderIdCounter:1,nextShopIdCounter:1})},[I,o]);const t=I.shopSystem||{currencies:se,traders:[],shops:[],nextTraderIdCounter:1,nextShopIdCounter:1},h=t.currencies,g=t.traders,s=t.shops,C=m.useCallback(()=>{const r=`Trader_${t.nextTraderIdCounter}`;return o("shopSystem.nextTraderIdCounter",t.nextTraderIdCounter+1),r},[t.nextTraderIdCounter,o]),v=m.useCallback(()=>{const r=`Shop_${t.nextShopIdCounter}`;return o("shopSystem.nextShopIdCounter",t.nextShopIdCounter+1),r},[t.nextShopIdCounter,o]),i=m.useCallback(r=>{const l=[...h,r];o("shopSystem.currencies",l)},[h,o]),w=m.useCallback((r,l)=>{const c=h.findIndex(y=>y.id===r);if(c===-1)return;const u=[...h];u[c]={...u[c],...l},o("shopSystem.currencies",u)},[h,o]),R=m.useCallback(r=>{if(s.some(y=>y.shopItems.some(x=>x.overrideCurrencyId===r))){alert("Валюта используется в магазинах и не может быть удалена");return}const c=h.find(y=>y.id===r);if(c!=null&&c.isDefault){alert("Нельзя удалить стандартную валюту");return}const u=h.filter(y=>y.id!==r);o("shopSystem.currencies",u)},[h,s,o]),b=m.useCallback(r=>{const l=h.map(c=>({...c,isDefault:c.id===r}));o("shopSystem.currencies",l)},[h,o]),M=m.useCallback(()=>h.find(r=>r.isDefault),[h]),S=m.useCallback(r=>{const l=[...g,r];o("shopSystem.traders",l)},[g,o]),O=m.useCallback((r,l)=>{const c=g.findIndex(y=>y.traderId===r);if(c===-1)return;const u=[...g];u[c]={...u[c],...l},o("shopSystem.traders",u)},[g,o]),F=m.useCallback(r=>{const l=g.filter(c=>c.traderId!==r);o("shopSystem.traders",l)},[g,o]),j=m.useCallback(r=>g.find(l=>l.shopId===r),[g]),_=m.useCallback(r=>{const l=[...s,r];o("shopSystem.shops",l)},[s,o]),N=m.useCallback((r,l)=>{const c=s.findIndex(y=>y.shopId===r);if(c===-1)return;const u=[...s];u[c]={...u[c],...l},o("shopSystem.shops",u)},[s,o]),k=m.useCallback(r=>{const l=g.find(u=>u.shopId===r);if(l){alert(`Магазин используется торговцем "${l.name}" и не может быть удален`);return}const c=s.filter(u=>u.shopId!==r);o("shopSystem.shops",c)},[s,g,o]),E=m.useCallback(r=>s.find(l=>l.shopId===r),[s]),V=m.useCallback((r,l)=>{const c=s.findIndex(T=>T.shopId===r);if(c===-1)return;if(s[c].shopItems.findIndex(T=>T.id===l.id)!==-1){alert("Предмет уже существует в магазине");return}const y={...s[c],shopItems:[...s[c].shopItems,l]},x=[...s];x[c]=y,o("shopSystem.shops",x)},[s,o]),$=m.useCallback((r,l,c)=>{const u=s.findIndex(U=>U.shopId===r);if(u===-1)return;const y=s[u].shopItems.findIndex(U=>U.id===l);if(y===-1)return;const x=[...s[u].shopItems];x[y]={...x[y],...c};const T={...s[u],shopItems:x},J=[...s];J[u]=T,o("shopSystem.shops",J)},[s,o]),q=m.useCallback((r,l)=>{const c=s.findIndex(T=>T.shopId===r);if(c===-1)return;const u=s[c].shopItems.filter(T=>T.id!==l),y={...s[c],shopItems:u},x=[...s];x[c]=y,o("shopSystem.shops",x)},[s,o]),P=m.useCallback(r=>{var u,y,x,T;const l=(y=(u=I.balance)==null?void 0:u.comparisonItems)==null?void 0:y.find(J=>J.name===r);if(l)return l;const c=(T=(x=I.resources)==null?void 0:x.items)==null?void 0:T.find(J=>J.name===r||J.id===r);if(c)return{name:c.name,tier:1,mechanic:"Найти в мире",selectedCategories:[c.category],selectedModifiers:[],selectedLocations:[],frequencyType:"Часто встречаемый",craftComplexity:"Не крафтиться",imageId:c.imageId}},[(f=I.balance)==null?void 0:f.comparisonItems,(d=I.resources)==null?void 0:d.items]),p=m.useCallback((r,l)=>{var x,T,J;const c=M();if(!c)return 0;let u=0;if(r.craftValue!==void 0&&r.craftValue>0&&r.hasCraftRecipe===!0)u=r.craftValue;else{const U=(x=I.balance)==null?void 0:x.currentConfig;if(!U)return 0;if(u=U.baseValue*(1+(r.tier-1)*.5),r.selectedCategories&&r.selectedCategories.length>0){let L=0;r.selectedCategories.forEach(Y=>{L+=U.categories[Y]||1}),L/=r.selectedCategories.length,u*=L}r.subType&&U.subTypeModifiers&&U.subTypeModifiers[r.subType]&&(u*=U.subTypeModifiers[r.subType])}const y=((J=(T=I.balance)==null?void 0:T.currentConfig)==null?void 0:J.buyMarkup)||.25;if(u*=1+y,l&&l!==c.id){const U=h.find(L=>L.id===l);if(U&&U.exchangeRate)return Math.round(u/U.exchangeRate)}return Math.round(u)},[I.balance,h,M]),e=m.useCallback(r=>{o("shopSystem",r)},[o]),a=m.useCallback(()=>({currencies:h,traders:g,shops:s,nextTraderIdCounter:t.nextTraderIdCounter,nextShopIdCounter:t.nextShopIdCounter}),[h,g,s,t.nextTraderIdCounter,t.nextShopIdCounter]),n={currencies:h,traders:g,shops:s,addCurrency:i,updateCurrency:w,deleteCurrency:R,setDefaultCurrency:b,getDefaultCurrency:M,addTrader:S,updateTrader:O,deleteTrader:F,getTraderByShopId:j,addShop:_,updateShop:N,deleteShop:k,getShopById:E,addItemToShop:V,updateShopItem:$,removeItemFromShop:q,getItemById:P,calculateItemPrice:p,generateNewTraderId:C,generateNewShopId:v,importShopData:e,exportShopData:a};return z.jsx(ie.Provider,{value:n,children:A})}function be(){const A=m.useContext(ie);if(!A)throw new Error("useShop must be used within a ShopProvider");return A}export{Se as A,Ie as B,he as N,xe as S,Ce as a,be as b,re as u};
