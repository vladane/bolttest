import{r as h,j as e,d as te,L as V,c as q}from"./vendor-react-B5bTltmH.js";import{u as G}from"./app-contexts-DyyK1F6R.js";import{J as Y,i as Z}from"./vendor-other-CPcG8nbB.js";import{r as re,h as se,s as ae,l as ne,j as oe}from"./utils-CqSnstQE.js";function ie(){const[t,s]=h.useState(!0);h.useEffect(()=>{document.documentElement.classList.add("dark"),s(!0),localStorage.setItem("theme","dark");const u=window.matchMedia("(prefers-color-scheme: dark)"),m=c=>{localStorage.getItem("theme")||(s(c.matches),document.documentElement.classList.toggle("dark",c.matches))};return u.addEventListener("change",m),()=>u.removeEventListener("change",m)},[]);const k=()=>{const u=!t;s(u),u?(document.documentElement.classList.add("dark"),localStorage.setItem("theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("theme","light"))};return e.jsx("button",{onClick:k,className:"flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-800 transition-colors","aria-label":t?"Switch to light mode":"Switch to dark mode",children:t?e.jsx("svg",{className:"w-5 h-5 text-yellow-300",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z",clipRule:"evenodd"})}):e.jsx("svg",{className:"w-5 h-5 text-gray-400",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"})})})}function ce(){const{state:t,setFullState:s}=G(),[k,u]=h.useState(!1),[m,c]=h.useState(!1),I=h.useRef(null),l=async()=>{var C,o,d,R,v,F,$,w,S,a,x,M,A,f,T,n,r,g;u(!0),console.log("Starting export process...");try{const j=new Y,O=j.folder("images");if(O===null)throw new Error("Failed to create images folder in zip archive");const i={units:t.units.units,items:t.units.items,abilities:t.units.abilities,resources:{items:t.resources.items,categories:t.resources.categories,nextImageId:t.resources.nextImageId},recipes:t.recipes,balance:{currentConfig:t.balance.currentConfig,savedConfigs:t.balance.savedConfigs,comparisonItems:t.balance.comparisonItems},craftSystem:{recipes:JSON.parse(JSON.stringify(t.craftSystem.recipes||[])),variants:JSON.parse(JSON.stringify(t.craftSystem.variants||[])),nextRecipeId:t.craftSystem.nextRecipeId,nextVariantId:t.craftSystem.nextVariantId},mixingSystem:{recipes:JSON.parse(JSON.stringify(t.mixingSystem.recipes||[])),spoiledFood:JSON.parse(JSON.stringify(t.mixingSystem.spoiledFood||[])),nextRecipeId:t.mixingSystem.nextRecipeId},shopSystem:t.shopSystem?{currencies:JSON.parse(JSON.stringify(t.shopSystem.currencies||[])),traders:JSON.parse(JSON.stringify(t.shopSystem.traders||[])),shops:JSON.parse(JSON.stringify(t.shopSystem.shops||[])),nextTraderIdCounter:t.shopSystem.nextTraderIdCounter,nextShopIdCounter:t.shopSystem.nextShopIdCounter}:void 0,imageMap:{}};console.log("Экспорт данных:",{unitsCount:((C=i.units)==null?void 0:C.length)||0,itemsCount:((o=i.items)==null?void 0:o.length)||0,comparisonItemsCount:((R=(d=i.balance)==null?void 0:d.comparisonItems)==null?void 0:R.length)||0,craftSystemRecipesCount:((F=(v=i.craftSystem)==null?void 0:v.recipes)==null?void 0:F.length)||0,mixingSystemRecipesCount:((w=($=i.mixingSystem)==null?void 0:$.recipes)==null?void 0:w.length)||0,shopSystemShopsCount:((a=(S=i.shopSystem)==null?void 0:S.shops)==null?void 0:a.length)||0,shopSystemTradersCount:((M=(x=i.shopSystem)==null?void 0:x.traders)==null?void 0:M.length)||0,unitsImageMapSize:t.units.imageMap.size,resourcesImageMapSize:t.resources.imageMap.size}),t.units.imageMap&&t.units.imageMap.size>0&&(console.log(`Exporting ${t.units.imageMap.size} images from units`),t.units.imageMap.forEach((b,y)=>{if(!b||!b.data){console.warn(`Image ${y} has no data, skipping`);return}try{let p,J=b.type||"image/png";if(typeof b.data=="string"&&b.data.startsWith("data:")){const P=b.data.match(/^data:(.+);base64,(.+)$/);if(P)J=P[1],p=P[2];else{console.warn(`Invalid data URL format for image ${y}`);return}}else p=b.data;const U=`${y}.${J==="image/jpeg"?"jpg":J==="image/png"?"png":J==="image/gif"?"gif":"png"}`;O.file(U,p,{base64:!0}),i.imageMap[y]={fileName:U,type:J,source:"units"},console.log(`Exported image ${y} as ${U}`)}catch(p){console.error(`Error processing image ${y}:`,p)}})),t.resources.imageMap&&t.resources.imageMap.size>0&&(console.log(`Exporting ${t.resources.imageMap.size} images from resources`),t.resources.imageMap.forEach((b,y)=>{if(!(!b||!b.data))try{let p,J=b.type||"image/png";if(typeof b.data=="string"&&b.data.startsWith("data:")){const P=b.data.match(/^data:(.+);base64,(.+)$/);if(P)J=P[1],p=P[2];else return}else p=b.data;const U=`${y}.${J==="image/jpeg"?"jpg":J==="image/png"?"png":J==="image/gif"?"gif":"png"}`;O.file(U,p,{base64:!0}),i.imageMap[y]={fileName:U,type:J,source:"resources"}}catch(p){console.error(`Error processing resource image ${y}:`,p)}})),j.file("project.json",JSON.stringify(i,null,2));try{const b={timestamp:new Date().toISOString(),exportedSystems:{units:!0,resources:!0,craftSystem:!!((f=(A=i.craftSystem)==null?void 0:A.recipes)!=null&&f.length),mixingSystem:!!((n=(T=i.mixingSystem)==null?void 0:T.recipes)!=null&&n.length),shopSystem:!!((g=(r=i.shopSystem)==null?void 0:r.shops)!=null&&g.length)}};localStorage.setItem("last_export_debug",JSON.stringify(b))}catch(b){console.warn("Unable to save debug data to localStorage:",b)}const E=await j.generateAsync({type:"blob"}),N=URL.createObjectURL(E),z=document.createElement("a");z.href=N,z.download=`game-builder-project-${new Date().toISOString().slice(0,10)}.zip`,document.body.appendChild(z),z.click(),setTimeout(()=>{document.body.removeChild(z),URL.revokeObjectURL(N)},100),u(!1),console.log("Export completed successfully")}catch(j){console.error("Error exporting project:",j),alert(`Error exporting project: ${j instanceof Error?j.message:"Unknown error"}`),u(!1)}},L=async C=>{var d,R,v,F,$,w,S,a,x,M,A,f,T,n,r;const o=(d=C.target.files)==null?void 0:d[0];if(o){c(!0),console.log("Starting import process...");try{const g=await Y.loadAsync(o),j=g.file("project.json");if(!j)throw new Error("Invalid project file: project.json not found");const O=await j.async("text"),i=JSON.parse(O);console.log("Parsed project data:",{unitsCount:((R=i.units)==null?void 0:R.length)||0,itemsCount:((v=i.items)==null?void 0:v.length)||0,comparisonItemsCount:(($=(F=i.balance)==null?void 0:F.comparisonItems)==null?void 0:$.length)||0,craftSystemRecipesCount:((S=(w=i.craftSystem)==null?void 0:w.recipes)==null?void 0:S.length)||0,mixingSystemRecipesCount:((x=(a=i.mixingSystem)==null?void 0:a.recipes)==null?void 0:x.length)||0,shopSystemShopsCount:((A=(M=i.shopSystem)==null?void 0:M.shops)==null?void 0:A.length)||0,imageMapCount:Object.keys(i.imageMap||{}).length});const E=new Map,N=new Map,z=Object.keys(g.files).filter(y=>!g.files[y].dir);if(console.log("Files in archive:",z.slice(0,10).join(", ")+(z.length>10?` (and ${z.length-10} more)`:"")),i.imageMap&&Object.keys(i.imageMap).length>0){console.log("Loading images from imageMap...");const y=[];for(const[p,J]of Object.entries(i.imageMap)){const{fileName:D,type:U,source:P}=J;console.log(`Processing image ${p} (${D})`);let W=null;const X=[`images/${D}`,`images/${p}.png`,`images/${p}.jpg`,D,`${p}.png`,`${p}.jpg`];for(const B of X)if(z.includes(B)){W=B,console.log(`Found image at path: ${B}`);break}if(!W){for(const B of z)if(B.includes(p)){W=B,console.log(`Found image by ID pattern: ${B}`);break}}if(!W){console.warn(`Could not find image for ${p}`);continue}const H=g.file(W);if(!H){console.warn(`Could not load file at path ${W}`);continue}const ee=H.async("base64").then(B=>{const Q=`data:${U};base64,${B}`;P==="resources"?(N.set(p,{data:Q,type:U}),console.log(`Added image ${p} to resourcesImageMap`)):(E.set(p,{data:Q,type:U}),console.log(`Added image ${p} to unitsImageMap`))}).catch(B=>{console.error(`Error loading image ${p}:`,B)});y.push(ee)}await Promise.all(y),console.log(`Loaded ${E.size} unit images and ${N.size} resource images`)}const b={units:{...t.units,units:i.units||[],items:i.items||[],abilities:i.abilities||[],imageMap:E.size>0?E:t.units.imageMap,nextImageId:Math.max(t.units.nextImageId,...Array.from(E.keys()).filter(y=>typeof y=="string"&&y.startsWith("id_")).map(y=>{const p=parseInt(y.substring(3).split("_")[0],10);return isNaN(p)?0:p}))+1},resources:{...t.resources,items:((f=i.resources)==null?void 0:f.items)||[],categories:((T=i.resources)==null?void 0:T.categories)||[],imageMap:N.size>0?N:t.resources.imageMap,nextImageId:Math.max(t.resources.nextImageId,...Array.from(N.keys()).filter(y=>typeof y=="string"&&y.startsWith("id_")).map(y=>{const p=parseInt(y.substring(3).split("_")[0],10);return isNaN(p)?0:p}))+1},recipes:i.recipes||t.recipes,balance:i.balance||t.balance,craftSystem:i.craftSystem||{recipes:[],variants:[],nextRecipeId:1,nextVariantId:1},mixingSystem:i.mixingSystem||{recipes:[],spoiledFood:t.mixingSystem.spoiledFood,nextRecipeId:1},shopSystem:i.shopSystem||{currencies:((n=t.shopSystem)==null?void 0:n.currencies)||[],traders:[],shops:[],nextTraderIdCounter:1,nextShopIdCounter:1}};if((r=b.balance)!=null&&r.comparisonItems){console.log(`Checking ${b.balance.comparisonItems.length} comparison items for image references`);let y=0;b.balance.comparisonItems.forEach(p=>{if(p.imageId){const J=E.has(p.imageId)||N.has(p.imageId);console.log(`Item "${p.name}" has imageId "${p.imageId}" which ${J?"exists":"does NOT exist"} in imageMap`),J&&y++}}),console.log(`Found ${y} items with valid image references`)}window.__importedImages={units:E,resources:N},console.log("Сохранены ссылки на изображения в глобальном контексте:",{unitsSize:E.size,resourcesSize:N.size}),await s(b),console.log("State updated with setFullState"),c(!1),console.log("Import completed successfully"),alert("Project imported successfully!"),C.target&&(C.target.value="")}catch(g){console.error("Error importing project:",g),alert(`Error importing project: ${g instanceof Error?g.message:"Unknown error"}`),c(!1),C.target&&(C.target.value="")}}};return e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("input",{type:"file",id:"import-project",ref:I,accept:".zip",className:"hidden",onChange:L,disabled:m}),e.jsx("button",{onClick:()=>{var C;return(C=I.current)==null?void 0:C.click()},disabled:m,className:`px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center ${m?"opacity-50 cursor-not-allowed":""}`,children:m?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Importing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-4 h-4 mr-2",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})}),"Import Project"]})}),e.jsx("button",{onClick:l,disabled:k,className:`px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors flex items-center ${k?"opacity-50 cursor-not-allowed":""}`,children:k?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Exporting..."]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-4 h-4 mr-2",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),"Export Project"]})})]})}function he(){const t=te(),s=u=>t.pathname===u||t.pathname.startsWith(u+"/"),k=()=>s("/balance-crafting")||s("/balance")||s("/crafting");return e.jsxs("div",{className:"bg-gray-900 w-64 min-h-screen text-white flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-gray-800 flex justify-between items-center",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Game Designer Suite"}),e.jsx(ie,{})]}),e.jsxs("div",{className:"p-4 border-b border-gray-800",children:[e.jsx("h2",{className:"text-sm uppercase tracking-wider text-gray-400 font-semibold mb-3",children:"Программы"}),e.jsxs("nav",{className:"space-y-2",children:[e.jsx(V,{to:"/units",className:`block py-2 px-4 rounded transition ${s("/units")||t.pathname==="/"?"bg-indigo-900 text-white":"hover:bg-gray-800"}`,children:"Unit Builder"}),e.jsx(V,{to:"/mixing",className:`block py-2 px-4 rounded transition ${s("/mixing")?"bg-indigo-900 text-white":"hover:bg-gray-800"}`,children:"Mixing System"}),e.jsx(V,{to:"/balance-crafting",className:`block py-2 px-4 rounded transition ${k()?"bg-indigo-900 text-white":"hover:bg-gray-800"}`,children:"Balance & Crafting Center"}),e.jsx(V,{to:"/shop-builder",className:`block py-2 px-4 rounded transition ${s("/shop-builder")?"bg-indigo-900 text-white":"hover:bg-gray-800"}`,children:"Shop Builder"}),e.jsx(V,{to:"/neorust",className:`block py-2 px-4 rounded transition ${s("/neorust")?"bg-indigo-900 text-white":"hover:bg-gray-800"}`,children:"NeoRust Editor"})]})]}),e.jsx("div",{className:"p-4 mt-auto",children:e.jsxs("div",{className:"mt-6 border-t border-gray-200 dark:border-gray-700 pt-4",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"Export/Import"}),e.jsx(ce,{})]})})]})}function xe({onImageUpload:t,onUpload:s,currentImageId:k,size:u="md",className:m=""}){const{state:c,updateState:I}=G(),[l,L]=h.useState(!1),[C,o]=h.useState(null),d=h.useRef(null),R={sm:"w-12 h-12",md:"w-16 h-16",lg:"w-24 h-24"},v=w=>{var x;const S=(x=w.target.files)==null?void 0:x[0];if(!S)return;if(o(null),S.size>2*1024*1024){o("File size must be less than 2MB"),d.current&&(d.current.value="");return}if(!S.type.startsWith("image/")){o("Only image files are allowed"),d.current&&(d.current.value="");return}L(!0);const a=new FileReader;a.onload=M=>{var A;try{const f=(A=M.target)==null?void 0:A.result;if(f){const T=`id_${Date.now()}_${Math.floor(Math.random()*1e3)}`,n=new Map(c.units.imageMap||new Map);let r=S.type,g=f;if(f.startsWith("data:")){const j=f.split(",");if(j.length===2){const O=j[0].match(/data:([^;]+);/);O&&O[1]&&(r=O[1]),g=j[1]}}n.set(T,{type:r,data:g}),I("units.imageMap",n),c.units.nextImageId!==void 0&&I("units.nextImageId",(c.units.nextImageId||0)+1),typeof t=="function"?t(T):typeof s=="function"&&s(T),d.current&&(d.current.value="")}}catch(f){console.error("Error processing image:",f),o("Failed to process image")}finally{L(!1)}},a.onerror=()=>{console.error("Error reading file"),o("Failed to read file"),L(!1),d.current&&(d.current.value="")},a.onabort=()=>{console.error("File reading aborted"),o("File reading was aborted"),L(!1),d.current&&(d.current.value="")},a.readAsDataURL(S)},$=(w=>{if(!w||!c.units.imageMap||!c.units.imageMap.has(w))return null;try{const S=c.units.imageMap.get(w);return S?typeof S.data=="string"&&S.data.startsWith("data:")?S.data:`data:${S.type};base64,${S.data}`:null}catch(S){return console.error("Error getting image URL:",S),null}})(k);return e.jsxs("div",{className:`flex items-center space-x-3 ${m}`,children:[e.jsx("div",{className:`${R[u]} bg-gray-100 dark:bg-gray-800 rounded-md overflow-hidden flex items-center justify-center cursor-pointer border-2 border-dashed border-gray-300 dark:border-gray-600 hover:border-primary dark:hover:border-primary transition-colors`,onClick:()=>{var w;return(w=d.current)==null?void 0:w.click()},children:l?e.jsx("div",{className:"animate-spin h-6 w-6 border-2 border-primary border-t-transparent rounded-full"}):$?e.jsx("img",{src:$,className:"w-full h-full object-contain",alt:"Uploaded image",onError:w=>{console.error("Error loading image:",$),w.currentTarget.src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'}}):e.jsx("span",{className:"text-gray-400 text-2xl",children:"+"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm mb-1 text-gray-800 dark:text-gray-200",children:$?"Replace image":"Upload image"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"PNG, JPG or GIF (max 2MB)"}),C&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:C})]}),e.jsx("input",{type:"file",ref:d,className:"hidden",accept:"image/png,image/jpeg,image/gif",onChange:v})]})}function ye(){const{state:t,setFullState:s}=G(),[k,u]=h.useState([]),[m,c]=h.useState(""),[I,l]=h.useState(!1),[L,C]=h.useState("save"),[o,d]=h.useState(!1),[R,v]=h.useState(null),F=h.useRef({recipesCount:0});h.useEffect(()=>{I&&$()},[I]),h.useEffect(()=>{re(()=>t)},[t]),h.useEffect(()=>{F.current.recipesCount=t.craftSystem.recipes.length;try{if(t.craftSystem.recipes.length>0){const n={recipes:JSON.parse(JSON.stringify(t.craftSystem.recipes)),variants:JSON.parse(JSON.stringify(t.craftSystem.variants)),nextRecipeId:t.craftSystem.nextRecipeId,nextVariantId:t.craftSystem.nextVariantId};localStorage.setItem("craftSystem_backup",JSON.stringify(n))}}catch(n){console.error("Ошибка резервного копирования:",n)}},[t.craftSystem.recipes]);const $=async()=>{try{d(!0);const n=await se();u(n),d(!1)}catch(n){console.error("Error loading saves list:",n),d(!1)}},w=(n,r=null)=>{var O,i,E,N,z,b,y,p,J,D,U,P;const g=r||t,j=((O=g.craftSystem)==null?void 0:O.recipes)||[];console.log(`[ДИАГНОСТИКА ${n}]`,{unitsCount:((E=(i=g.units)==null?void 0:i.units)==null?void 0:E.length)||0,itemsCount:((z=(N=g.units)==null?void 0:N.items)==null?void 0:z.length)||0,abilitiesCount:((y=(b=g.units)==null?void 0:b.abilities)==null?void 0:y.length)||0,resourcesCount:((J=(p=g.resources)==null?void 0:p.items)==null?void 0:J.length)||0,craftRecipesCount:j.length||0,craftRecipeIds:j.map(W=>W.id).slice(0,5),nextRecipeId:(D=g.craftSystem)==null?void 0:D.nextRecipeId,balanceItemsCount:((P=(U=g.balance)==null?void 0:U.comparisonItems)==null?void 0:P.length)||0})},S=()=>({units:t.units.units||[],items:t.units.items||[],abilities:t.units.abilities||[],resources:{items:t.resources.items||[],categories:t.resources.categories||[],imageMap:{},nextImageId:t.resources.nextImageId||1},recipes:{recipes:t.recipes.recipes||[],nextId:t.recipes.nextId||1},balance:{currentConfig:JSON.parse(JSON.stringify(t.balance.currentConfig)),savedConfigs:JSON.parse(JSON.stringify(t.balance.savedConfigs)),comparisonItems:JSON.parse(JSON.stringify(t.balance.comparisonItems))},craftSystem:{recipes:JSON.parse(JSON.stringify(t.craftSystem.recipes||[])),variants:JSON.parse(JSON.stringify(t.craftSystem.variants||[])),nextRecipeId:t.craftSystem.nextRecipeId||1,nextVariantId:t.craftSystem.nextVariantId||1},mixingSystem:{recipes:JSON.parse(JSON.stringify(t.mixingSystem.recipes||[])),spoiledFood:JSON.parse(JSON.stringify(t.mixingSystem.spoiledFood||[])),nextRecipeId:t.mixingSystem.nextRecipeId||1},shopSystem:t.shopSystem?{currencies:JSON.parse(JSON.stringify(t.shopSystem.currencies||[])),traders:JSON.parse(JSON.stringify(t.shopSystem.traders||[])),shops:JSON.parse(JSON.stringify(t.shopSystem.shops||[])),nextTraderIdCounter:t.shopSystem.nextTraderIdCounter||1,nextShopIdCounter:t.shopSystem.nextShopIdCounter||1}:void 0,imageMap:{}}),a=async()=>{var n,r,g,j;if(!m.trim()){alert("Please enter a name for your save");return}try{if(d(!0),w("ПЕРЕД СОХРАНЕНИЕМ"),!t.units.units.length&&!t.units.items.length&&!((r=(n=t.resources)==null?void 0:n.items)!=null&&r.length)&&!((j=(g=t.craftSystem)==null?void 0:g.recipes)!=null&&j.length)&&!confirm("You're about to save a project with no data. Continue?")){d(!1);return}const O=S();try{localStorage.setItem("last_save_data",JSON.stringify({name:m,timestamp:new Date().toISOString(),craftSystemOnly:O.craftSystem}))}catch(i){console.warn("Не удалось сохранить страховочную копию:",i)}await ae(m,O),c(""),l(!1),d(!1),alert("Game saved successfully!"),$()}catch(O){console.error("Error saving game:",O),alert(`Error saving game: ${O instanceof Error?O.message:"Unknown error"}`),d(!1)}},x=async n=>{try{d(!0),v(null);let r=await ne(n);if(!r)throw new Error("Save data is empty or corrupted");if(w("ЗАГРУЖЕННЫЕ ДАННЫЕ",r),!r.craftSystem)try{const g=localStorage.getItem("craftSystem_backup");g?r.craftSystem=JSON.parse(g):r.craftSystem={recipes:[],variants:[],nextRecipeId:1,nextVariantId:1}}catch{r.craftSystem={recipes:[],variants:[],nextRecipeId:1,nextVariantId:1}}if(s)await s(r),l(!1),d(!1),alert("Game loaded successfully!");else throw new Error("setFullState function is not available")}catch(r){console.error("Error loading game:",r),v(`Error loading game: ${r instanceof Error?r.message:"Unknown error"}`),alert(`Error loading game: ${r instanceof Error?r.message:"Unknown error"}`),d(!1)}},M=n=>{var j;const r=(j=n.target.files)==null?void 0:j[0];if(!r)return;d(!0),v(null);const g=new FileReader;g.onload=async O=>{var i;try{const E=(i=O.target)==null?void 0:i.result,N=JSON.parse(E);if(w("ИМПОРТИРУЕМЫЕ ДАННЫЕ",N),!N||typeof N!="object")throw new Error("Invalid file format. Expected a JSON object.");if(!N.craftSystem)try{const z=localStorage.getItem("craftSystem_backup");z?N.craftSystem=JSON.parse(z):N.craftSystem={recipes:[],variants:[],nextRecipeId:1,nextVariantId:1}}catch{N.craftSystem={recipes:[],variants:[],nextRecipeId:1,nextVariantId:1}}await s(N),l(!1),d(!1),alert("Import successful!")}catch(E){console.error("Error importing file:",E),v(`Error importing file: ${E instanceof Error?E.message:"Unknown error"}`),d(!1)}},g.onerror=()=>{v("Error reading file"),d(!1)},g.readAsText(r)},A=async n=>{if(confirm("Are you sure you want to delete this save?"))try{d(!0),await oe(n),d(!1),$()}catch(r){console.error("Error deleting save:",r),alert(`Error deleting save: ${r instanceof Error?r.message:"Unknown error"}`),d(!1)}},f=n=>{C(n),l(!0),v(null)},T=n=>{try{return new Date(n).toLocaleString()}catch{return n}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex space-x-2 flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>f("save"),className:"px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors",children:"Save Project"}),e.jsx("button",{onClick:()=>f("load"),className:"px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors",children:"Load Project"})]}),I&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg max-w-lg w-full",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:L==="save"?"Save Project":"Load Project"}),R&&e.jsx("div",{className:"mb-4 p-3 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-md",children:R}),L==="save"&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Save Name"}),e.jsx("input",{type:"text",value:m,onChange:n=>c(n.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",placeholder:"Enter save name"})]}),L==="load"&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Import from File"}),e.jsx("input",{type:"file",accept:".json",onChange:M,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:"Or select from saved projects below"})]}),e.jsx("div",{className:"max-h-60 overflow-y-auto mb-4",children:o?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx("div",{className:"animate-spin h-8 w-8 border-2 border-primary border-t-transparent rounded-full"})}):k.length===0?e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-center py-3",children:"No saves yet"}):e.jsx("ul",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:k.map(n=>e.jsx("li",{className:"py-2",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:n.name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:T(n.timestamp)})]}),e.jsxs("div",{className:"flex space-x-2",children:[L==="load"&&e.jsx("button",{onClick:()=>x(n.id),className:"px-2 py-1 bg-blue-600 text-white rounded text-sm",children:"Load"}),e.jsx("button",{onClick:()=>A(n.id),className:"px-2 py-1 bg-red-600 text-white rounded text-sm",children:"Delete"})]})]})},n.id))})}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx("button",{onClick:()=>l(!1),className:"px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md",children:"Cancel"}),L==="save"&&e.jsx("button",{onClick:a,disabled:o||!m.trim(),className:`px-4 py-2 bg-green-600 text-white rounded-md ${o||!m.trim()?"opacity-50 cursor-not-allowed":"hover:bg-green-700"}`,children:o?"Saving...":"Save"})]})]})})]})}class le extends h.Component{constructor(s){super(s),this.state={hasError:!1,error:null}}static getDerivedStateFromError(s){return{hasError:!0,error:s}}componentDidCatch(s,k){console.error("Caught error:",s),console.error("Component stack:",k.componentStack)}render(){var s;return this.state.hasError?this.props.fallback||e.jsxs("div",{className:"p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md text-red-600 dark:text-red-400",children:[e.jsx("h3",{className:"font-medium mb-1",children:"Проблема с отображением компонента"}),e.jsxs("p",{className:"text-xs",children:["Ошибка: ",(s=this.state.error)==null?void 0:s.message]})]}):this.props.children}}function _(t){try{const s={...t};if(s.series&&(Array.isArray(s.series)||(s.series=[s.series]),s.series=s.series.map(u=>{if(!u)return{type:"line",data:[]};const m=u;return m.type||(console.warn("Series missing type, defaulting to line"),m.type="line"),["line","bar","scatter","pie"].includes(m.type)&&!m.data&&(m.data=[]),m.type==="radar"&&(m.data?Array.isArray(m.data)&&(m.data=m.data.map(c=>c?(c.value||(c.value=[0]),c):{value:[0],name:"No data"})):m.data=[{value:[0],name:"No data"}]),m})),s.series&&Array.isArray(s.series)&&s.series.some(u=>u.type==="radar")){const u=s.radar;(!u||!u.indicator||!Array.isArray(u.indicator)||u.indicator.length===0)&&(s.radar={...s.radar||{},indicator:[{name:"Default",max:10}]})}return s}catch(s){return console.error("Error validating options:",s),{series:[{type:"line",data:[]}]}}}const de=({options:t,style:s={height:"300px",width:"100%"},className:k="",theme:u,onEvents:m={},onChartInit:c})=>{const I=h.useRef(null),l=h.useRef(null),[L,C]=h.useState(null);return h.useEffect(()=>{if(I.current)try{const o=document.documentElement.classList.contains("dark"),d=u||(o?"dark":"light");l.current&&l.current.dispose(),l.current=Z(I.current,d,{renderer:"canvas",useDirtyRect:!1}),c&&l.current&&c(l.current);const R={backgroundColor:"transparent",textStyle:{color:o?"#e5e7eb":"#1f2937"},legend:{textStyle:{color:o?"#e5e7eb":"#1f2937"}},xAxis:{axisLine:{lineStyle:{color:o?"#4b5563":"#d1d5db"}},splitLine:{lineStyle:{color:o?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}}},yAxis:{axisLine:{lineStyle:{color:o?"#4b5563":"#d1d5db"}},splitLine:{lineStyle:{color:o?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}}},tooltip:{show:!0,trigger:"item",confine:!0,enterable:!0,backgroundColor:o?"rgba(30, 30, 30, 0.9)":"rgba(255, 255, 255, 0.9)",borderColor:o?"#555":"#ddd",borderWidth:1,padding:8,textStyle:{color:o?"#fff":"#333",fontSize:12},extraCssText:"box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); z-index: 100;"}},v=_(t),F=v.series&&Array.isArray(v.series)&&v.series.some(x=>x.type==="radar");if(F&&(Object.assign(R,{radar:{shape:"polygon",splitNumber:5,axisLine:{lineStyle:{color:o?"rgba(255,255,255,0.2)":"rgba(0,0,0,0.2)"}},splitLine:{show:!0,lineStyle:{color:o?"rgba(255,255,255,0.2)":"rgba(0,0,0,0.2)"}},splitArea:{show:!0,areaStyle:{color:o?["rgba(255,255,255,0.03)","rgba(255,255,255,0.06)"]:["rgba(0,0,0,0.02)","rgba(0,0,0,0.04)"]}}}}),!v.tooltip||v.tooltip&&!v.tooltip.formatter)){const M={...R.tooltip,formatter:function(A){if(!A)return"";let f;if(Array.isArray(A)?f=A[0]:f=A,!f||f.value===void 0)return"";const{name:T,value:n,dimensionNames:r}=f;let g=`<div style="font-weight:bold;margin-bottom:4px">${T||"Параметры"}</div>`;if(Array.isArray(n)){const O=(v.radar||{}).indicator||[];n.forEach((i,E)=>{const N=O[E]||{name:`Параметр ${E+1}`},z=N.name||(r==null?void 0:r[E])||`Параметр ${E+1}`,b=N.max||0,y=b>0?Math.round(i/b*100):0;g+=`<div style="display:flex;justify-content:space-between;margin:2px 0">
                    <span>${z}:</span>
                    <span style="font-weight:bold;margin-left:8px">${i.toFixed(2)}${b?` (${y}%)`:""}</span>
                  </div>`})}else typeof n=="number"?g+=`<div>${n}</div>`:g+=`<div>${JSON.stringify(n)}</div>`;return g}};R.tooltip=M}const $={...R,...v};F&&($.tooltip&&($.tooltip.show=!0),$.series&&$.series.forEach(x=>{x.type==="radar"&&!x.symbolSize&&(x.symbolSize=8)})),l.current.setOption($,!0),l.current.on("mouseover",x=>{console.log("Chart mouseover:",x)}),Object.entries(m).forEach(([x,M])=>{l.current&&l.current.on(x,A=>{M(A)})});const w=window.matchMedia("(prefers-color-scheme: dark)"),S=x=>{const M=x.matches,A=document.documentElement.classList.contains("dark");if(M===A&&l.current&&I.current){l.current.dispose(),l.current=Z(I.current,M?"dark":"light");const f={...R};if(f.textStyle&&(f.textStyle.color=M?"#e5e7eb":"#1f2937"),f.legend&&typeof f.legend=="object"){const r=f.legend;r.textStyle&&(r.textStyle.color=M?"#e5e7eb":"#1f2937")}if(f.xAxis){const r=Array.isArray(f.xAxis)?f.xAxis[0]:f.xAxis;r&&r.axisLine&&r.axisLine.lineStyle&&(r.axisLine.lineStyle.color=M?"#4b5563":"#d1d5db")}if(f.yAxis){const r=Array.isArray(f.yAxis)?f.yAxis[0]:f.yAxis;r&&r.axisLine&&r.axisLine.lineStyle&&(r.axisLine.lineStyle.color=M?"#4b5563":"#d1d5db")}const T=_(t),n={...f,...T};l.current.setOption(n,!0),c&&l.current&&c(l.current),Object.entries(m).forEach(([r,g])=>{l.current&&l.current.on(r,j=>{g(j)})})}};w.addEventListener&&w.addEventListener("change",S);const a=new ResizeObserver(()=>{l.current&&l.current.resize()});return I.current&&a.observe(I.current),()=>{l.current&&l.current.dispose(),l.current=null,w.removeEventListener&&w.removeEventListener("change",S),a.disconnect()}}catch(o){console.error("Error initializing chart:",o),C(o instanceof Error?o:new Error(String(o)))}},[u,t,c,m]),h.useEffect(()=>{if(l.current&&t)try{const o=_(t);l.current.setOption(o,{notMerge:!0,lazyUpdate:!1,replaceMerge:["tooltip","series","radar"]}),l.current.resize()}catch(o){console.error("Error updating chart:",o),C(o instanceof Error?o:new Error(String(o)))}},[t]),h.useEffect(()=>{const o=()=>{l.current&&l.current.resize()};return window.addEventListener("resize",o),()=>{window.removeEventListener("resize",o)}},[]),L?e.jsxs("div",{className:"p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md text-red-600 dark:text-red-400",children:[e.jsx("h3",{className:"font-medium mb-1",children:"Проблема с отображением диаграммы"}),e.jsxs("p",{className:"text-xs",children:["Ошибка: ",L.message]})]}):e.jsx("div",{ref:I,className:`echarts-wrapper ${k}`,style:{...s,position:"relative",overflow:"visible"}})};function be(t){return e.jsx(le,{fallback:e.jsxs("div",{className:"p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md text-red-600 dark:text-red-400",children:[e.jsx("h3",{className:"font-medium mb-1",children:"Проблема с отображением диаграммы"}),e.jsx("p",{className:"text-xs",children:"Произошла ошибка при рендеринге графика"})]}),children:e.jsx(de,{...t})})}function Se({items:t,value:s,onChange:k,placeholder:u="Select item",className:m=""}){const[c,I]=h.useState(!1),[l,L]=h.useState(""),[C,o]=h.useState("all"),d=h.useRef(null),R=h.useRef(null),v=new Set;v.add("all"),t.forEach(a=>{a.category?v.add(a.category):a.selectedCategories&&a.selectedCategories.length>0&&a.selectedCategories.forEach(x=>v.add(x))});const F=Array.from(v),w=[...t.filter(a=>{const x=a.name.toLowerCase().includes(l.toLowerCase()),M=C==="all"||a.category===C||a.selectedCategories&&a.selectedCategories.includes(C);return x&&M})].sort((a,x)=>a.tier!==x.tier?a.tier-x.tier:a.name.localeCompare(x.name));h.useEffect(()=>{function a(x){d.current&&!d.current.contains(x.target)&&I(!1)}return document.addEventListener("mousedown",a),()=>{document.removeEventListener("mousedown",a)}},[]),h.useEffect(()=>{c&&R.current&&R.current.focus()},[c]);const S=t.find(a=>a.name===s);return e.jsxs("div",{className:`relative w-full ${m}`,ref:d,children:[e.jsxs("button",{type:"button",className:"w-full px-4 py-2 text-left bg-gray-100 dark:bg-gray-800 border border-gray-600 dark:border-gray-700 rounded-md flex justify-between items-center",onClick:()=>I(!c),children:[e.jsx("span",{children:S?`${S.name} (Tier ${S.tier})`:u}),e.jsx("svg",{className:`w-5 h-5 transition-transform ${c?"transform rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),c&&e.jsxs("div",{className:"absolute z-10 mt-1 w-full bg-white dark:bg-gray-800 border border-gray-600 dark:border-gray-700 rounded-md shadow-lg max-h-80 overflow-hidden",children:[e.jsx("div",{className:"p-2 sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-600 dark:border-gray-700",children:e.jsx("input",{ref:R,type:"text",placeholder:"Search items...",className:"w-full px-3 py-2 border border-gray-600 dark:border-gray-700 rounded-md bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100",value:l,onChange:a=>L(a.target.value),onClick:a=>a.stopPropagation()})}),F.length>1&&e.jsx("div",{className:"p-2 flex flex-wrap gap-1 border-b border-gray-600 dark:border-gray-700",children:F.map(a=>e.jsx("button",{className:`px-2 py-1 text-xs rounded-full ${C===a?"bg-blue-500 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200"}`,onClick:()=>o(a),children:a==="all"?"All Categories":a},a))}),e.jsx("div",{className:"overflow-y-auto max-h-60",children:w.length>0?e.jsx("div",{className:"py-1",children:w.map(a=>e.jsx("button",{className:`w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 ${s===a.name?"bg-blue-50 dark:bg-blue-900/30":""}`,onClick:()=>{k(a.name),I(!1),L("")},children:e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:a.name}),e.jsxs("span",{className:"text-gray-500 dark:text-gray-400",children:["(Tier ",a.tier,")"]})]})},a.name))}):e.jsx("div",{className:"px-4 py-2 text-gray-500 dark:text-gray-400 text-center",children:"No items found"})})]})]})}const me=({message:t,type:s="info",duration:k=3e3,onClose:u})=>{h.useEffect(()=>{const c=setTimeout(()=>{u()},k);return()=>clearTimeout(c)},[k,u]);const m={info:"bg-blue-500",success:"bg-green-500",warning:"bg-yellow-500",error:"bg-red-500"};return e.jsx("div",{className:`fixed bottom-4 right-4 z-50 p-4 rounded-md shadow-md text-white ${m[s]} transition-opacity duration-300`,children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"ml-3 flex-1 pr-4",children:e.jsx("p",{className:"text-sm font-medium",children:t})}),e.jsx("button",{onClick:u,className:"text-white hover:text-gray-200 focus:outline-none",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})})},K=q.createContext({addToast:()=>{},removeToast:()=>{}}),ve=()=>q.useContext(K),we=({children:t})=>{const[s,k]=h.useState([]),u=(c,I="info")=>{const l=Date.now().toString();k(L=>[...L,{id:l,message:c,type:I}])},m=c=>{k(I=>I.filter(l=>l.id!==c))};return e.jsxs(K.Provider,{value:{addToast:u,removeToast:m},children:[t,e.jsx("div",{className:"toast-container",children:s.map(c=>e.jsx(me,{message:c.message,type:c.type,onClose:()=>m(c.id)},c.id))})]})};export{be as E,xe as I,Se as S,we as T,he as a,ye as b,ve as u};
