function J(e,s){if(e.craftValue!==void 0&&e.craftValue>0&&e.hasCraftRecipe===!0)return e.craftValue;const t=e.selectedCategories.reduce((m,a)=>m+(s.categories[a]||0),0),r=s.weights.categoryWeight*(e.selectedCategories.length>0?t/e.selectedCategories.length:0),n=s.weights.tierWeight*(1+(e.tier-1)*s.tierMultiplier),i=s.weights.mechanicWeight*(s.mechanics[e.mechanic]||1),o=e.selectedModifiers.reduce((m,a)=>m+(s.modifiers[a]||0),0),l=s.weights.modifiersWeight*(e.selectedModifiers.length>0?o/e.selectedModifiers.length:1),f=e.selectedLocations.reduce((m,a)=>m+(s.locations[a]||0),0),u=s.weights.locationsWeight*(e.selectedLocations.length>0?f/e.selectedLocations.length:1),g=s.weights.frequencyWeight*(s.frequencyTypes[e.frequencyType]||1),c=s.weights.craftComplexityWeight*(s.craftComplexityTypes[e.craftComplexity]||1),d=s.baseValue*(r+n+i+l+u+g+c);return Math.round(d)}function O(e,s,t){return e.reduce((r,n)=>{const i=s.find(o=>o.name===n.itemName);return i?r+J(i,t)*n.amount:r},0)}function P(e,s,t){if(!e.variants||e.variants.length===0)return 0;const r=e.variants.map(n=>O(n.ingredients,s,t));return Math.min(...r)}function _(e,s,t){const r=P(e,s,t),n=s.find(f=>f.name===e.resultItemName),i=(n==null?void 0:n.craftComplexity)||"Не крафтиться",o=t.craftComplexityTypes[i]||1,l=t.craftBaseMultiplier+o*t.craftComplexityMultiplier;return Math.round(r*l)}function G(e,s){if(!e)return null;try{if(s.units.imageMap&&s.units.imageMap.has(e)){const t=s.units.imageMap.get(e);return!t||!t.data?null:typeof t.data=="string"&&t.data.startsWith("data:")?t.data:`data:${t.type||"image/png"};base64,${t.data}`}if(s.resources.imageMap&&s.resources.imageMap.has(e)){const t=s.resources.imageMap.get(e);return!t||!t.data?null:typeof t.data=="string"&&t.data.startsWith("data:")?t.data:`data:${t.type||"image/png"};base64,${t.data}`}return null}catch(t){return console.error(`Error getting image URL for ${e}:`,t),null}}const R="game-builder-db",q=1,y={SAVES:"saves"};async function D(){return new Promise((e,s)=>{const t=indexedDB.open(R,q);t.onupgradeneeded=r=>{const n=r.target.result;n.objectStoreNames.contains(y.SAVES)||n.createObjectStore(y.SAVES,{keyPath:"id"})},t.onsuccess=r=>{e(r.target.result)},t.onerror=r=>{s(`Database error: ${r.target.error}`)}})}function W(e){var s;if(!e)return e;try{e.craftSystem?console.log(`[DB] craftSystem найден, содержит ${((s=e.craftSystem.recipes)==null?void 0:s.length)||0} рецептов`):(console.warn("[DB] craftSystem отсутствует в данных!"),e.data&&e.data.craftSystem?(e.craftSystem=JSON.parse(JSON.stringify(e.data.craftSystem)),console.log("[DB] craftSystem найден в data.data и перемещен на верхний уровень")):(e.craftSystem={recipes:[],variants:[],nextRecipeId:1,nextVariantId:1},console.log("[DB] Создан пустой craftSystem")));try{e.craftSystem&&e.craftSystem.recipes&&e.craftSystem.recipes.length>0&&(localStorage.setItem("craftSystem_backup",JSON.stringify(e.craftSystem)),console.log(`[DB] Резервная копия craftSystem сохранена с ${e.craftSystem.recipes.length} рецептами`))}catch(t){console.error("[DB] Ошибка при создании резервной копии:",t)}return e}catch(t){return console.error("[DB] Ошибка обеспечения craftSystem:",t),e}}async function U(e,s){const t=await D();return new Promise((r,n)=>{var l,f,u,g;const o=t.transaction([y.SAVES],"readwrite").objectStore(y.SAVES);try{const c=W(s);console.log("[DB] Проверка структуры данных перед сохранением:",{hasCraftSystem:!!c.craftSystem,craftRecipesCount:((f=(l=c.craftSystem)==null?void 0:l.recipes)==null?void 0:f.length)||0});const d={id:e,name:e,data:c,timestamp:new Date().toISOString()};console.log(`[DB] Сохраняем данные с ${((g=(u=d.data.craftSystem)==null?void 0:u.recipes)==null?void 0:g.length)||0} рецептами`);const m=o.put(d);m.onsuccess=()=>{var a,p;console.log(`[DB] Сохранение успешно: ${e}, рецептов: ${((p=(a=c.craftSystem)==null?void 0:a.recipes)==null?void 0:p.length)||0}`),r(e)},m.onerror=()=>{console.error("[DB] Ошибка при сохранении:",m.error),n(m.error)}}catch(c){console.error("[DB] Критическая ошибка при подготовке данных:",c),n(c)}})}function k(e){var s,t;if(!e)return e;try{if(console.log("[DB] Проверка загруженных данных:",{hasData:!!e,hasCraftSystem:!!e.craftSystem}),e.craftSystem)console.log(`[DB] craftSystem найден: ${((t=e.craftSystem.recipes)==null?void 0:t.length)||0} рецептов`);else{console.warn("[DB] В загруженных данных отсутствует craftSystem!");try{const r=localStorage.getItem("craftSystem_backup");r?(e.craftSystem=JSON.parse(r),console.log(`[DB] Восстановлен craftSystem из резервной копии: ${((s=e.craftSystem.recipes)==null?void 0:s.length)||0} рецептов`)):(e.craftSystem={recipes:[],variants:[],nextRecipeId:1,nextVariantId:1},console.log("[DB] Создан пустой craftSystem, резервная копия отсутствует"))}catch(r){console.error("[DB] Ошибка при восстановлении из резервной копии:",r),e.craftSystem={recipes:[],variants:[],nextRecipeId:1,nextVariantId:1}}}return e}catch(r){return console.error("[DB] Ошибка при проверке/восстановлении данных:",r),e}}async function j(e){const s=await D();return new Promise((t,r)=>{const o=s.transaction([y.SAVES],"readonly").objectStore(y.SAVES).get(e);o.onsuccess=()=>{var l,f;if(o.result){console.log("[DB] Raw DB result:",o.result);let u=o.result.data;u=k(u),console.log(`[DB] Загружены данные с ${((f=(l=u.craftSystem)==null?void 0:l.recipes)==null?void 0:f.length)||0} рецептами`),t(u)}else console.error("No save found with ID:",e),r(new Error(`No save found with ID: ${e}`))},o.onerror=()=>{console.error("Error loading save:",o.error),r(o.error)}})}async function z(){const e=await D();return new Promise((s,t)=>{const i=e.transaction([y.SAVES],"readonly").objectStore(y.SAVES).getAll();i.onsuccess=()=>{s(i.result)},i.onerror=()=>{t(i.error)}})}async function K(e){const s=await D();return new Promise((t,r)=>{const o=s.transaction([y.SAVES],"readwrite").objectStore(y.SAVES).delete(e);o.onsuccess=()=>{t(!0)},o.onerror=()=>{r(o.error)}})}const A=JSON.stringify;let x=()=>null;function Q(e){if(x!==null&&x!==(()=>null)){console.log("CraftSystemPatch: State getter already registered, skipping redundant registration");return}x=e,console.log("CraftSystemPatch: State getter registered")}JSON.stringify=function(e,s,t){if(e&&typeof e=="object"&&e.balance&&e.balance.comparisonItems&&e.resources&&!e.craftSystem){console.log("CraftSystemPatch: Обнаружены экспортируемые данные без нужных систем, добавляем...");try{const r=x();if(r){const n={...e};return r.craftSystem&&(n.craftSystem={recipes:JSON.parse(JSON.stringify(r.craftSystem.recipes||[])),variants:JSON.parse(JSON.stringify(r.craftSystem.variants||[])),nextRecipeId:r.craftSystem.nextRecipeId||1,nextVariantId:r.craftSystem.nextVariantId||1},console.log(`CraftSystemPatch: craftSystem добавлен с ${n.craftSystem.recipes.length} рецептами`)),r.mixingSystem&&!n.mixingSystem&&(n.mixingSystem={recipes:JSON.parse(JSON.stringify(r.mixingSystem.recipes||[])),spoiledFood:JSON.parse(JSON.stringify(r.mixingSystem.spoiledFood||[])),nextRecipeId:r.mixingSystem.nextRecipeId||1},console.log(`CraftSystemPatch: mixingSystem добавлен с ${n.mixingSystem.recipes.length} рецептами`)),r.shopSystem&&!n.shopSystem&&(n.shopSystem={currencies:JSON.parse(JSON.stringify(r.shopSystem.currencies||[])),traders:JSON.parse(JSON.stringify(r.shopSystem.traders||[])),shops:JSON.parse(JSON.stringify(r.shopSystem.shops||[])),nextTraderIdCounter:r.shopSystem.nextTraderIdCounter||1,nextShopIdCounter:r.shopSystem.nextShopIdCounter||1},console.log(`CraftSystemPatch: shopSystem добавлен с ${n.shopSystem.shops.length} магазинами`)),A(n,s,t)}else console.warn("CraftSystemPatch: Не удалось получить состояние приложения")}catch(r){console.error("CraftSystemPatch: Ошибка при патче данных:",r)}}return A(e,s,t)};const V={"Очень легко":"Very Easy",Легко:"Easy",Средне:"Medium",Сложно:"Hard","Очень сложно":"Very Hard","Very Easy":"Очень легко",Easy:"Легко",Medium:"Средне",Hard:"Сложно","Very Hard":"Очень сложно"};function X(e,s,t){if(typeof e=="object"&&e!==null&&e.resultItemName&&Array.isArray(s)){const r=e,n=s;if(t&&t.craftTimeConfig)return H(r,n,t);const i=n.find(l=>l.name===r.resultItemName),o=(i==null?void 0:i.craftComplexity)||"Средне";return $(o,r.level||1,t)}return typeof s=="number"?$(e,s,t):$(e,1,t)}function $(e,s,t){if(!e||!t||!t.craftComplexityTypes)return 60;const r=t.craftComplexityTypes[e]||1,n=30,i=1+((s||1)-1)*.2;return Math.round(n*r*i)}function H(e,s,t){return F(e,s,t).totalTime}function Y(e,s="ru"){if(!e||e<0)return s==="en"?"0 sec":"0 сек";if(e<60)return s==="en"?`${e} sec`:`${e} сек`;if(e<3600){const t=Math.floor(e/60),r=e%60;return s==="en"?r>0?`${t} min ${r} sec`:`${t} min`:r>0?`${t} мин ${r} сек`:`${t} мин`}else if(e<86400){const t=Math.floor(e/3600),r=Math.floor(e%3600/60);return s==="en"?r>0?`${t} h ${r} min`:`${t} h`:r>0?`${t} ч ${r} мин`:`${t} ч`}else{const t=Math.floor(e/86400),r=Math.floor(e%86400/3600);return s==="en"?r>0?`${t} d ${r} h`:`${t} d`:r>0?`${t} д ${r} ч`:`${t} д`}}function L(e,s){if(s.baseTimesByComplexity[e]!==void 0)return s.baseTimesByComplexity[e];if(e in V){const t=V[e];if(t&&s.baseTimesByComplexity[t]!==void 0)return s.baseTimesByComplexity[t]}return 45}function F(e,s,t){if(console.log("getCraftTimeDetails - recipe:",e.name||e.resultItemName),console.log("getCraftTimeDetails - config:",t.craftTimeConfig),!t||!t.craftTimeConfig){console.log("craftTimeConfig missing - using old calculation");const a=s.find(h=>h.name===e.resultItemName),p=(a==null?void 0:a.craftComplexity)||"Средне",M=e.level||1,C=$(p,M,t);return{baseTime:C,ingredientsTime:0,totalTime:C,variantTimes:[]}}const r=s.find(a=>a.name===e.resultItemName);if(!r)return console.log("Result item not found:",e.resultItemName),{baseTime:60,ingredientsTime:0,totalTime:60,variantTimes:[]};const n=t.craftTimeConfig,i=r.craftComplexity||"Средне",o=L(i,n),f=1+((e.level||1)-1)*n.levelMultiplier,u=Math.round(o*f);let g=1;if(e.isSeasonDependent&&t.currentSeason&&(e.availableSeasons&&e.availableSeasons.length>0&&(e.availableSeasons.includes(t.currentSeason)||(g=1.5,console.log(`Рецепт недоступен в текущем сезоне (${t.currentSeason}), множитель времени: ${g}`))),e.seasonalMultipliers&&e.seasonalMultipliers[t.currentSeason])){const a=e.seasonalMultipliers[t.currentSeason];g*=a,console.log(`Применяем сезонный модификатор рецепта для ${t.currentSeason}: ${a}`)}const c=[];if(e.variants&&e.variants.length>0)for(const a of e.variants){if(!a.ingredients||!Array.isArray(a.ingredients)){c.push({variantId:a.id,time:0,breakdown:[]});continue}let p=0;const M=[];let C=!1;for(const h of a.ingredients){if(!h.itemName||!h.amount)continue;const S=s.find(T=>T.name===h.itemName);if(!S)continue;S.isHarvest&&S.growingSeason&&t.currentSeason&&(S.growingSeason.includes(t.currentSeason)||(C=!0,console.log(`Ингредиент ${h.itemName} - сезонный и недоступен в текущем сезоне`)));let v=n.ingredientBaseTime,N=1;if(S.selectedCategories&&S.selectedCategories.length>0){const T=S.selectedCategories.map(b=>n.categoryTimeMultipliers[b]||1);T.length>0&&(N=T.reduce((b,E)=>b+E,0)/T.length),v*=N}const w=1+((S.tier||1)-1)*.2;v*=w,S.isHarvest&&S.growingSeason&&t.currentSeason&&(S.growingSeason.includes(t.currentSeason)||(v*=1.3));const B=Math.pow(h.amount,n.ingredientScalingFactor),I=Math.round(v*B);p+=I,M.push({itemName:h.itemName,amount:h.amount,baseTime:n.ingredientBaseTime,categoryMultiplier:N,tierFactor:w,scaleFactor:B,totalTime:I})}C&&(p=Math.round(p*1.2)),c.push({variantId:a.id,time:p,breakdown:M})}const d=c.length>0?Math.min(...c.map(a=>a.time)):0,m=Math.round((u+d)*g);return{baseTime:u,ingredientsTime:d,totalTime:m,variantTimes:c}}function Z(e,s,t,r=1){if(!e||!t||e<=0||t<=0)return 1;const n=e*s*r/t;return Math.max(1,Math.ceil(n))}function ee(e){return!!(e&&e.name&&e.resultItemName&&e.variants&&Array.isArray(e.variants)&&e.variants.length>0)}export{O as a,F as b,_ as c,X as d,Z as e,Y as f,G as g,z as h,ee as i,K as j,j as l,Q as r,U as s};
